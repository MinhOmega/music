name: Auto Merge PR
#
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, review_requested, review_request_removed, ready_for_review]

jobs:
  auto-merge:
    if: github.event.pull_request.base.ref == 'developer'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check approvals
        id: check_approvals
        run: |
          required_approvers=(${{ secrets.REQUIRED_APPROVERS }})
          approvals=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                        "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews" | \
                        jq -r '.[] | select(.state == "APPROVED") | .user.login')

          approvals_count=0
          for approver in "${required_approvers[@]}"; do
            if echo "${approvals[@]}" | grep -q "${approver}"; then
              ((approvals_count++))
            fi
          done

          if [[ $approvals_count -eq ${#required_approvers[@]} ]]; then
            echo "approved_by_all=true" >> $GITHUB_ENV
          else
            echo "approved_by_all=false" >> $GITHUB_ENV

      - name: Auto merge if approved by all required users
        if: env.approved_by_all == 'true'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --admin --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

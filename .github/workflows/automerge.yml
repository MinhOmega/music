name: Auto Merge PR
#
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, review_requested, review_request_removed, edited]

jobs:
  auto-merge:
    if: github.event.pull_request.base.ref == 'developer'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get PR approvals
        id: get-approvals
        run: |
          echo "REQUIRED_APPROVERS=${{ secrets.REQUIRED_APPROVERS }}" >> $GITHUB_ENV
          pr_number=${{ github.event.pull_request.number }}
          approvals=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${pr_number}/reviews" \
            | jq '[.[] | select(.state == "APPROVED") | .user.login]')
          echo "APPROVALS=${approvals}" >> $GITHUB_ENV

      - name: Check if PR has required approvals
        id: check-approvals
        run: |
          IFS=',' read -ra REQUIRED_USERS <<< "${{ env.REQUIRED_APPROVERS }}"
          for user in "${REQUIRED_USERS[@]}"; do
            if ! echo "${{ env.APPROVALS }}" | grep -q "$user"; then
              echo "Required approver $user has not approved yet."
              exit 1
            fi
          done

      - name: Merge PR
        if: steps.check-approvals.outputs.success == 'true'
        uses: pascalgn/automerge-action@v0.14.3
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          merge-method: merge
          branch: developer
